name: CI / CD - develop (preview)

on:
  push:
    branches: 
      - develop

jobs:
  pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write  

    steps:
      # --- Checkout do código ---
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # --- Cache do npm ---
      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # --- Instalação de dependências ---
      - name: Instalar dependências
        run: npm install --force

      # --- Instala semver globalmente ---
      - name: Instalar semver
        run: npm install -g semver

      # --- Calcular nova versão com sufixo preview ---
      - name: Calcular versão Preview
        id: version
        run: |
          git fetch --tags --force --prune

          # Última tag vX.Y.Z (sem preview)
          LAST_TAG=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1)
          if [ -z "$LAST_TAG" ]; then
            CURRENT_VERSION="0.0.0"
          else
            CURRENT_VERSION="${LAST_TAG#v}"
          fi

          # Incrementa patch
          NEW_VERSION=$(semver -i patch "$CURRENT_VERSION")

          # Conta quantos previews já existem para essa versão base
          COUNT=$(git tag --list "v${NEW_VERSION}-preview.*" | grep -c '^' || echo 0)
          PREVIEW_NUM=$((COUNT + 1))
          PREVIEW_TAG="v${NEW_VERSION}-preview.${PREVIEW_NUM}"

          # Exporta para steps seguintes
          echo "preview_tag=$PREVIEW_TAG" >> $GITHUB_OUTPUT
          echo "PREVIEW_TAG=$PREVIEW_TAG" >> $GITHUB_ENV

      # --- Criar Release Preview ---
      - name: Criar Release Preview
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.preview_tag }}
          name: "Preview ${{ steps.version.outputs.preview_tag }}"
          body: |
            Preview automático gerado a partir do branch `develop`.

            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Trigger: ${{ github.event_name }}
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
